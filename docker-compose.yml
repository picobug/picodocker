version: '3.3'

services:

### VSFTPD Container #######################################
            
    vsftpd:
        build:
            context: ./vsftpd
        ports:
        - "21:21"
        - "21100-21110:21100-21110"
        volumes:
            - ../www/media:/home/julio/
            - ../www:/var/www
        environment:
            FTP_USER: julio
            FTP_PASS: pico
            PASV_ADDRESS: 172.16.1.8
            PASV_MIN: 21100
            PASV_MAX: 21110
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.8

### Redis Container #######################################
    
    redis:
        build:
            context: ./redis
        volumes:
            - redis:/data
            - ../www:/var/www
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.7

### Nodes Container #######################################
    
    node:
        build:
            context: ./node
        ports:
            - "9001:8080"
        volumes:
            - ./node/dist:/usr/src/app/dist
        networks:
            default:
                ipv4_address: 172.16.1.9

### PHP-FPM Container #######################################

    php7:
        build:
            context: ./php7
        volumes:
            - ../www:/var/www
            - ./php7/www.conf:/etc/php7/php-fpm.d/www.conf
        links:
            - "mariadb:mdb"
            - "postgres:pdb"
            - vsftpd
            - redis
        extra_hosts:
            - "keepo.dev:172.16.1.5"
            - "m.keepo.dev:172.16.1.5"
            - "media.keepo.dev:172.16.1.5"
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.6

### Nginx Server Container ##################################

    nginx:
        build:
            context: ./nginx
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ../www:/var/www
            - ./logs/nginx/:/var/log/nginx
            - ./nginx/conf.d/:/etc/nginx/conf.d/
            - ./nginx/site.conf:/etc/nginx/nginx.conf
        links:
            - php7:php-fpm
            # - node
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.5

### Nginx Server Container ##################################

    pagespeed:
        build:
            context: ./pagespeed
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ../www:/var/www
            - ./logs/nginx/:/var/log/nginx
            - ./pagespeed/conf.d/:/etc/nginx/conf.d/
            - ./pagespeed/sites-enabled/:/etc/nginx/sites-enabled/
            - ./pagespeed/nginx.conf:/etc/nginx/nginx.conf
        links:
            - php7:php-fpm
            # - node
        networks:
            default:
                ipv4_address: 172.16.1.5

### MariaDB Container #######################################

    mariadb:
        build: ./mariadb
        command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
        volumes:
            - ../www:/var/www
            - mariadb:/var/lib/mysql
        ports:
            - "3306:3306"
        environment:
            MYSQL_DATABASE: julio_pico
            MYSQL_USER: julio
            MYSQL_PASSWORD: pico
            MYSQL_ROOT_PASSWORD: root
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.10

### PostgreSQL Container ####################################

    postgres:
        build: ./postgres
        volumes:
            - ../www:/var/www
            - postgres:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        environment:
            POSTGRES_DB: julio
            POSTGRES_USER: julio
            POSTGRES_PASSWORD: pico
        restart: always
        networks:
            default:
                ipv4_address: 172.16.1.11

volumes:
  mariadb:
    driver: "local"
  redis:
    driver: "local"
  postgres:
    driver: "local"
  sessions:    ## nothing is connected to this (- ./data/sessions:/sessions)
    driver: "local"

networks:
    default:
        driver: bridge
        ipam:
            config:
                - subnet: 172.16.1.0/24
